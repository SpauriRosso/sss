#!/usr/bin/env bash
set -Eeuo pipefail

echo "=== NETTOYAGE HISTORIQUE AMÃ‰LIORÃ‰ ==="
echo "Version: 4.0 - Nettoyage complet"
echo

# DÃ©sactiver complÃ¨tement l'historique pour ce script
export HISTFILE=/dev/null HISTSIZE=0 HISTFILESIZE=0
history -c 2>/dev/null || true

echo "ğŸ“‚ Suppression des fichiers d'historique..."

# Liste exhaustive des fichiers d'historique
declare -a HIST_FILES=(
    # Bash
    "/root/.bash_history" "/root/.bash_eternal_history" "/root/.local/state/bash/history"
    # Zsh  
    "/root/.zsh_history" "/root/.zsh_sessions" "/root/.local/state/zsh/history"
    # Fish
    "/root/.local/share/fish/fish_history" "/root/.config/fish/fish_history" "/root/.local/state/fish/fish_history"
    # Autres shells
    "/root/.history" "/root/.ksh_history" "/root/.sh_history" "/root/.tcsh_history"
    # Applications
    "/root/.python_history" "/root/.ipython_history" "/root/.mysql_history" "/root/.psql_history"
    "/root/.sqlite_history" "/root/.rediscli_history" "/root/.lesshst"
    # Home directories des utilisateurs
    "/home/*/.bash_history" "/home/*/.zsh_history" "/home/*/.fish_history" "/home/*/.python_history"
)

# Supprimer chaque fichier d'historique
for file_pattern in "${HIST_FILES[@]}"; do
    # Expansion pour les patterns *
    for file in $file_pattern; do
        if [[ -e "$file" ]]; then
            echo "  ğŸ—‘ï¸ Suppression: $file ($(stat -c%s "$file" 2>/dev/null || echo '?') octets)"
            # Suppression irrÃ©versible
            rm -f "$file" 2>/dev/null && echo "    âœ… SupprimÃ©"
        fi
    done
done

echo
echo "ğŸ”§ DÃ©sactivation permanente de l'historique..."

# CrÃ©er/Modifier .bashrc pour dÃ©sactiver l'historique
for bashrc in /root/.bashrc /home/*/.bashrc; do
    [[ -f "$bashrc" ]] || continue
    echo "  ğŸ“ Configuration: $bashrc"
    
    # Ajouter les lignes de dÃ©sactivation (sans doublons)
    if ! grep -q "HISTFILE=/dev/null" "$bashrc"; then
        echo "" >> "$bashrc"
        echo "# DÃ©sactivation historique - Nettoyage automatique" >> "$bashrc"
        echo "export HISTFILE=/dev/null" >> "$bashrc"
        echo "export HISTSIZE=0" >> "$bashrc"
        echo "export HISTFILESIZE=0" >> "$bashrc"
        echo "export HISTCONTROL=ignoreboth" >> "$bashrc"
        echo "  âœ… ConfigurÃ©"
    else
        echo "    â„¹ï¸ DÃ©jÃ  configurÃ©"
    fi
done

# DÃ©sactiver dans /etc/profile pour tous les utilisateurs
echo "  ğŸ“ Configuration systÃ¨me: /etc/profile"
if [[ -f "/etc/profile" ]]; then
    if ! grep -q "HISTFILE=/dev/null" "/etc/profile"; then
        echo "" >> "/etc/profile"
        echo "# DÃ©sactivation historique globale" >> "/etc/profile"
        echo "export HISTFILE=/dev/null" >> "/etc/profile"
        echo "export HISTSIZE=0" >> "/etc/profile" 
        echo "export HISTFILESIZE=0" >> "/etc/profile"
        echo "  âœ… ConfigurÃ©"
    else
        echo "    â„¹ï¸ DÃ©jÃ  configurÃ©"
    fi
else
    echo "    âš ï¸ Fichier /etc/profile non trouvÃ©"
fi

echo
echo "ğŸ§¹ Nettoyage mÃ©moire..."

# Vider complÃ¨tement l'historique en mÃ©moire
history -c 2>/dev/null || true
history -w 2>/dev/null || true  # Ã‰crire l'historique vide
unset HISTFILE HISTSIZE HISTFILESIZE 2>/dev/null || true

echo "  âœ… MÃ©moire vidÃ©e"

echo
echo "ğŸ“Š VÃ©rification post-nettoyage :"

# VÃ©rifier si les fichiers existent encore
remaining=0
for file_pattern in "${HIST_FILES[@]}"; do
    for file in $file_pattern; do
        if [[ -e "$file" ]]; then
            echo "  âš ï¸ Fichier restant: $file"
            ((remaining++)) || true
        fi
    done
done

if [[ $remaining -eq 0 ]]; then
    echo "  âœ… Aucun fichier d'historique restant"
else
    echo "  âŒ $remaining fichiers d'historique encore prÃ©sents"
fi

echo
echo "ğŸ¯ TEST - Historique aprÃ¨s nettoyage :"
if command -v history >/dev/null 2>&1; then
    echo "  Commandes dans l'historique: $(history | wc -l 2>/dev/null || echo 0)"
else
    echo "  âŒ Commande 'history' non disponible"
fi

echo
echo "âœ… Nettoyage terminÃ© !"
echo "ğŸ’¡ Les nouveaux terminaux n'auront plus d'historique."
echo "ğŸ“ Pour vÃ©rifier: ouvrez un nouveau terminal et tapez 'history'"