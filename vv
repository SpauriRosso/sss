#!/usr/bin/env bash
set -Eeuo pipefail

echo "=== IMPROVED HISTORY CLEANUP ==="
echo "Version: 4.0 - Complete Cleanup"
echo

# Disable history for this script execution only
export HISTFILE=/dev/null HISTSIZE=0 HISTFILESIZE=0
history -c 2>/dev/null || true

echo "Deleting history files..."

# Exhaustive list of history files
declare -a HIST_FILES=(
    # Bash
    "/root/.bash_history" "/root/.bash_eternal_history" "/root/.local/state/bash/history"
    # Zsh
    "/root/.zsh_history" "/root/.zsh_sessions" "/root/.local/state/zsh/history"
    # Fish
    "/root/.local/share/fish/fish_history" "/root/.config/fish/fish_history" "/root/.local/state/fish/fish_history"
    # Other shells
    "/root/.history" "/root/.ksh_history" "/root/.sh_history" "/root/.tcsh_history"
    # Applications
    "/root/.python_history" "/root/.ipython_history" "/root/.mysql_history" "/root/.psql_history"
    "/root/.sqlite_history" "/root/.rediscli_history" "/root/.lesshst"
    # User home directories
    "/home/*/.bash_history" "/home/*/.zsh_history" "/home/*/.fish_history" "/home/*/.python_history"
)

# Delete each history file
for file_pattern in "${HIST_FILES[@]}"; do
    # Expansion for * patterns
    for file in $file_pattern; do
        if [[ -e "$file" ]]; then
            echo "  Deleting: $file ($(stat -c%s "$file" 2>/dev/null || echo '?') bytes)"
            # Irreversible deletion
            rm -f "$file" 2>/dev/null && echo "    Deleted"
        fi
    done
done

echo
echo "Cleaning memory..."

# Completely clear history in memory
history -c 2>/dev/null || true
history -w 2>/dev/null || true  # Write empty history
unset HISTFILE HISTSIZE HISTFILESIZE 2>/dev/null || true

echo "  Memory cleared"

echo
echo "Post-cleanup verification:"

# Check if files still exist
remaining=0
for file_pattern in "${HIST_FILES[@]}"; do
    for file in $file_pattern; do
        if [[ -e "$file" ]]; then
            echo "  Remaining file: $file"
            ((remaining++)) || true
        fi
    done
done

if [[ $remaining -eq 0 ]]; then
    echo "  No history files remaining"
else
    echo "  $remaining history files still present"
fi

echo
echo "TEST - History after cleanup:"
if command -v history >/dev/null 2>&1; then
    echo "  Commands in history: $(history | wc -l 2>/dev/null || echo 0)"
else
    echo "  Command 'history' not available"
fi

echo
echo "Cleanup finished!"
echo "New terminals will start with a fresh history."
echo "To verify: open a new terminal and type 'history'"